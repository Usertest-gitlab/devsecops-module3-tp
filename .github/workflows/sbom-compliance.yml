# ============================================================
# WORKFLOW SBOM & CONFORMIT√â
# Module 5 DevSecOps - Documentation et tra√ßabilit√©
# ============================================================

name: SBOM & Compliance

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Permet de lancer manuellement
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ============================================================
  # JOB 1: G√âN√âRATION SBOM
  # ============================================================
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -f Dockerfile.secure2 -t app:sbom .

      # ============================================================
      # SBOM avec Trivy (CycloneDX)
      # ============================================================
      - name: Generate SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'app:sbom'
          format: 'cyclonedx'
          output: 'sbom-cyclonedx.json'

      # ============================================================
      # SBOM avec Trivy (SPDX)
      # ============================================================
      - name: Generate SBOM (SPDX)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'app:sbom'
          format: 'spdx-json'
          output: 'sbom-spdx.json'

      # ============================================================
      # SBOM lisible (table)
      # ============================================================
      - name: Generate SBOM (Table)
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --format table \
            --list-all-pkgs \
            app:sbom > sbom-table.txt 2>&1 || true

      # ============================================================
      # UPLOAD ARTIFACTS
      # ============================================================
      - name: Upload SBOM CycloneDX
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom-cyclonedx.json
          retention-days: 90

      - name: Upload SBOM SPDX
        uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx
          path: sbom-spdx.json
          retention-days: 90

      - name: Upload SBOM Table
        uses: actions/upload-artifact@v4
        with:
          name: sbom-table
          path: sbom-table.txt
          retention-days: 90

      # ============================================================
      # R√âSUM√â DANS LES LOGS
      # ============================================================
      - name: Display SBOM summary
        run: |
          echo "=== SBOM SUMMARY ==="
          echo ""
          echo "üì¶ CycloneDX: sbom-cyclonedx.json"
          if [ -f sbom-cyclonedx.json ]; then
            COMPONENTS=$(jq '.components | length' sbom-cyclonedx.json 2>/dev/null || echo "N/A")
            echo "   Components: $COMPONENTS"
          fi
          echo ""
          echo "üì¶ SPDX: sbom-spdx.json"
          if [ -f sbom-spdx.json ]; then
            PACKAGES=$(jq '.packages | length' sbom-spdx.json 2>/dev/null || echo "N/A")
            echo "   Packages: $PACKAGES"
          fi
          echo ""
          echo "=== END SUMMARY ==="

  # ============================================================
  # JOB 2: V√âRIFICATION CONFORMIT√â
  # ============================================================
  compliance-check:
    name: Compliance Check
    runs-on: ubuntu-latest
    needs: generate-sbom

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download SBOM CycloneDX
        uses: actions/download-artifact@v4
        with:
          name: sbom-cyclonedx

      # ============================================================
      # V√âRIFICATION LICENCES
      # ============================================================
      - name: Check licenses
        run: |
          echo "=== LICENSE CHECK ==="
          if [ -f sbom-cyclonedx.json ]; then
            echo "Licenses found in SBOM:"
            jq -r '.components[]?.licenses[]?.license.id // .components[]?.licenses[]?.license.name // "Unknown"' sbom-cyclonedx.json 2>/dev/null | sort | uniq -c | sort -rn || echo "No license info"
          fi
          echo "=== END LICENSE CHECK ==="

      # ============================================================
      # CHECKLIST CONFORMIT√â
      # ============================================================
      - name: Compliance checklist
        run: |
          echo "=== COMPLIANCE CHECKLIST ==="
          echo ""

          # Check 1: SBOM exists
          if [ -f sbom-cyclonedx.json ]; then
            echo "‚úÖ SBOM generated (CycloneDX)"
          else
            echo "‚ùå SBOM missing"
          fi

          # Check 2: Dockerfile uses multi-stage
          if grep -q "AS builder" Dockerfile.secure2; then
            echo "‚úÖ Multi-stage build"
          else
            echo "‚ùå No multi-stage build"
          fi

          # Check 3: Non-root user
          if grep -q "USER nonroot\|USER nobody\|USER 1000" Dockerfile.secure2; then
            echo "‚úÖ Non-root user"
          else
            echo "‚ùå Running as root"
          fi

          # Check 4: No secrets in Dockerfile
          if ! grep -iE "password|secret|api_key|token" Dockerfile.secure2; then
            echo "‚úÖ No hardcoded secrets in Dockerfile"
          else
            echo "‚ö†Ô∏è  Potential secrets in Dockerfile"
          fi

          # Check 5: Pinned base image
          if grep -qE "FROM.*:[0-9]+\." Dockerfile.secure2; then
            echo "‚úÖ Pinned base image version"
          else
            echo "‚ö†Ô∏è  Base image not pinned"
          fi

          # Check 6: Security scan in CI
          if [ -f .github/workflows/secure-pipeline.yml ]; then
            echo "‚úÖ Security scan in CI"
          else
            echo "‚ùå No security scan workflow"
          fi

          # Check 7: DAST scan
          if [ -f .github/workflows/dast-zap.yml ]; then
            echo "‚úÖ DAST scan configured"
          else
            echo "‚ùå No DAST scan"
          fi

          echo ""
          echo "=== END CHECKLIST ==="
