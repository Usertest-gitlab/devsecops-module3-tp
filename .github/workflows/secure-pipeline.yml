# ============================================================
# WORKFLOW S√âCURIS√â - Module 4 DevSecOps
# D√©montre les bonnes pratiques de s√©curit√© CI/CD
# ============================================================

name: Secure Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# ============================================================
# 1. PERMISSIONS MINIMALES (Principe du moindre privil√®ge)
# ============================================================
# Par d√©faut, le GITHUB_TOKEN n'a AUCUNE permission
# Chaque job d√©clare uniquement les permissions n√©cessaires
permissions: {}

jobs:
  # ============================================================
  # JOB 1: BUILD
  # ============================================================
  build:
    name: Build Application
    runs-on: ubuntu-latest

    # Permissions minimales pour ce job
    permissions:
      contents: read  # Lecture du code uniquement

    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}

    steps:
      # Actions avec versions √âPINGL√âES (pas de @latest ou @main)
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "tag=app:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build -f Dockerfile.secure2 -t app:${{ github.sha }} .

      # Sauvegarder l'image pour les jobs suivants
      - name: Save image
        run: |
          docker save app:${{ github.sha }} -o image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar
          retention-days: 1

  # ============================================================
  # JOB 2: SECURITY SCAN (Trivy)
  # ============================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build

    permissions:
      contents: read
      security-events: write  # Pour upload SARIF (optionnel)

    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load image
        run: docker load -i image.tar

      # ============================================================
      # TRIVY BLOQUANT: exit-code: '1' fait √©chouer le pipeline
      # ============================================================
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'app:${{ github.sha }}'
          format: 'table'
          exit-code: '1'           # BLOQUE si vuln√©rabilit√©s
          ignore-unfixed: true     # Ignore les vulns sans fix
          severity: 'HIGH,CRITICAL'

      # Optionnel: Upload rapport SARIF pour GitHub Security
      - name: Trivy SARIF report
        uses: aquasecurity/trivy-action@0.24.0
        if: always()  # M√™me si le scan pr√©c√©dent √©choue
        with:
          image-ref: 'app:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================
  # JOB 3: TESTS
  # ============================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load and test image
        run: |
          docker load -i image.tar
          # Exemple: tester que le container d√©marre
          docker run --rm -d --name test-app -p 8080:8080 app:${{ github.sha }}
          sleep 5
          curl -f http://localhost:8080/health || exit 1
          docker stop test-app

  # ============================================================
  # JOB 4: DEPLOY (CLOISONN√â - uniquement sur main)
  # ============================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, security-scan, test]

    # ============================================================
    # CLOISONNEMENT: Ce job ne s'ex√©cute QUE sur la branche main
    # ============================================================
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    # Environment avec protection (n√©cessite approbation manuelle)
    # Configurer dans: Settings ‚Üí Environments ‚Üí production
    environment:
      name: production
      url: https://example.com

    permissions:
      contents: read
      # Ajouter d'autres permissions si n√©cessaire pour le d√©ploiement
      # packages: write  # Pour push vers GHCR
      # id-token: write  # Pour OIDC (AWS, Azure, GCP)

    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load image
        run: docker load -i image.tar

      - name: Deploy
        run: |
          echo "üöÄ Deploying app:${{ github.sha }} to production"
          # Ici: push vers registry, kubectl apply, etc.
          # docker push ghcr.io/${{ github.repository }}:${{ github.sha }}

  # ============================================================
  # JOB 5: CLEANUP (toujours ex√©cut√©)
  # ============================================================
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    permissions: {}  # Aucune permission n√©cessaire

    steps:
      - name: Cleanup summary
        run: |
          echo "Pipeline completed"
          echo "Branch: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
